# 领域模型改造计划 v3

基于 `docs/领域模型优化v3.md` 的评审意见，本阶段目标是从 **V2.5** 进化到 **V3.0**：
让 UI 只表达“意图（Intent）”，业务规则与播放策略内聚到 logic 层，并修复 Scheduler 生命周期不稳定的问题。

## 评审结论
- 建议**有道理且必要**：
  - 目前 Hook 仍在定义“目标模式”的具体规则（Leaky Logic）。
  - Scheduler 生命周期受 `useMemo` 依赖影响，存在“配置变更导致重建”风险（Fragile Lifecycle）。

---

## 总体目标
1. **策略内聚**：播放策略（role order / next index）在 logic 层统一定义。
2. **实例稳定**：Scheduler / Engine 实例在 React 中保持稳定引用，不被依赖变化重建。
3. **依赖更纯净**：AudioProvider 可替换、可测试，减少对 Hook 闭包的耦合。

---

## 分阶段计划

### 阶段 0：对齐目标与接口（0.5 天）
**动作**
- [x] 定义 `PlaybackStrategy` 结构（`nextIndex` + `getRoleOrder`）
- [x] 明确策略注册位置（`packages/logic/src/playback/strategies.ts`）
- [x] 统一 `PlaybackScheduler` 的策略选择入口（基于 `mode`）

**验收**
- 策略接口可读、可实现
- 旧策略兼容（NextIndex 未丢失）

---

### 阶段 1：策略内聚（1-2 天）
**动作**
- [x] 在 `packages/logic/src/playback/strategies.ts` 内实现 `PlaybackStrategy` 集合
- [x] `PlaybackScheduler` 在 `setMode` 时加载完整策略（含 `getRoleOrder`）
- [x] Hook 里移除 `getRoleOrder/getPrefetchRoles` 的 callback 逻辑

**验收**
- [x] Hook 只调用 `scheduler.setMode(mode)`
- [x] 目标模式不再在 UI 层定义

---

### 阶段 2：实例生命周期稳定（1 天）
**动作**
- [x] `PlaybackScheduler` 使用 `useState/useRef` 初始化（只创建一次）
- [x] `PlaybackEngine` 同步稳定化（避免 useMemo 依赖触发重建）
- [x] 用 `updateOptions` 更新配置（pause / repeats / provider / errorPolicy）

**验收**
- [x] Scheduler 引用稳定（无重建）
- [x] 播放中配置变化不会导致播放中断

---

### 阶段 3：AudioProvider 纯净化（可选，0.5-1 天）
**动作**
- [ ] 提供 `WebAudioProvider` 类（直接依赖 tRPC client 或 fetch）
- [ ] Hook 中只注入 provider 实例，不再传闭包函数
- [ ] 可替换 provider（Mock / LRU Cache / Offline）

**验收**
- Scheduler 可以脱离 React 运行
- provider 可独立测试/替换

---

## 里程碑验收清单（v3）
- [ ] PlaybackStrategy 含 `nextIndex` + `getRoleOrder`
- [ ] Hook 层不再定义 `loop-target` 规则
- [ ] Scheduler 实例稳定（useRef/useState lazy init）
- [ ] 播放中配置变化不会中断
- [ ] AudioProvider 可替换、可测试

---

## 风险与注意事项
- **行为一致性**：策略下沉后必须保持现有播放行为一致。
- **兼容旧模式**：`loop-all / loop-target / single / shadowing / random` 均需覆盖。
- **配置变更**：需确保 `updateOptions` 不影响当前播放序列。

---

## 开发顺序建议
**优先执行：阶段 2（稳定实例） → 阶段 1（策略内聚） → 阶段 3（provider 纯净化）**
- 稳定实例是潜在 bug 修复的关键；
- 策略内聚提升 DDD 纯度；
- Provider 纯净化是增强可测试性的加分项。
